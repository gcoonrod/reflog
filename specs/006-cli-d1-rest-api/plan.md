# Implementation Plan: CLI D1 REST API Migration

**Branch**: `006-cli-d1-rest-api` | **Date**: 2026-02-24 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `/specs/006-cli-d1-rest-api/spec.md`

## Summary

Replace the CLI's wrangler subprocess-based D1 access (`execFile("npx", ["wrangler", "d1", "execute", ...])`) with direct HTTP calls to the Cloudflare D1 REST API. This eliminates the wrangler dependency, enables parameterized queries (removing SQL injection surface), introduces lazy Auth0 config validation, and repurposes the `--env` flag to accept a `.env` file path for environment switching.

## Technical Context

**Language/Version**: TypeScript 5.x (strict mode, no `any`)
**Primary Dependencies**: Commander.js (CLI framework), `auth0` SDK v4.x (invite create only), `dotenv` (env file loading), native `fetch` (D1 REST API — no new HTTP dependency needed in Node 22)
**Storage**: Cloudflare D1 (SQLite on edge) accessed via REST API
**Testing**: Manual smoke testing against live D1 (no existing CLI test suite)
**Target Platform**: Node.js 22.x (operator's machine)
**Project Type**: CLI tool within monorepo workspace (`packages/cli`)
**Performance Goals**: N/A (operator tool, not user-facing)
**Constraints**: Must work without wrangler installed; must use parameterized queries
**Scale/Scope**: 3 command modules, 3 lib modules, 1 .env.example — ~10 files modified

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|---|---|---|
| I. Privacy-First, Device-Encrypted Data | PASS | CLI only accesses operational metadata (invites, waitlist, config). No user content is read or exposed. |
| II. Offline-First PWA | N/A | CLI is an operator tool, not the PWA. |
| III. Developer-Centric Minimalism | PASS | CLI interface unchanged; simpler setup (no wrangler login). |
| IV. Strict TypeScript & Modular Architecture | PASS | All code strict TS, no `any`. Types for D1 API response shapes. |
| V. Robust Error Boundaries | PASS | Replacing fragile stderr parsing with structured HTTP status code handling. Error messages improved. |
| VI. Git Flow & Commit Discipline | PASS | Feature branch from develop, typecheck must pass before commit. |

**Post-design re-check**: PASS — no new constitution concerns from Phase 1 design.

## Project Structure

### Documentation (this feature)

```text
specs/006-cli-d1-rest-api/
├── plan.md
├── research.md
├── data-model.md
├── quickstart.md
├── contracts/
│   └── d1-rest-api.md
└── tasks.md             # Generated by /speckit.tasks
```

### Source Code (files to modify)

```text
packages/cli/
├── src/
│   ├── index.ts            # Modify: --env flag repurposed to file path
│   ├── commands/
│   │   ├── invite.ts       # Modify: parameterized queries, lazy auth0 config
│   │   ├── waitlist.ts     # Modify: parameterized queries, new config interface
│   │   └── config.ts       # Modify: parameterized queries, new config interface
│   └── lib/
│       ├── config.ts       # Rewrite: two-tier config (core + auth0), --env path support
│       ├── d1.ts           # Rewrite: REST API client replacing wrangler subprocess
│       └── auth0.ts        # Minor: accept Auth0Config instead of full CliConfig
├── .env.example            # Update: new variable names
└── package.json            # Possible: remove unused dependencies if any
```

**Structure Decision**: No new files or directories needed. This is a refactor of existing modules within the `packages/cli` workspace. The file structure remains unchanged.

## Implementation Approach

### Phase 1: Core Infrastructure (lib/ modules)

1. **Rewrite `lib/d1.ts`** — Replace `execFile("npx", ["wrangler", ...])` with `fetch()` to the D1 REST API endpoint. New signature: `query<T>(sql: string, params: QueryParam[], config: CoreConfig)`. Handle all HTTP error codes per research.md R5 error taxonomy.

2. **Rewrite `lib/config.ts`** — Split into `loadCoreConfig()` and `loadAuth0Config()`. Accept optional `envPath` parameter. Use `dotenv` with the `path` option to load from specified file or default location. Validate core variables eagerly, auth0 variables lazily.

3. **Update `lib/auth0.ts`** — Change `getManagementClient()` and exported functions to accept `Auth0Config` instead of the full `CliConfig`. No functional changes to Auth0 logic.

### Phase 2: Command Modules

4. **Update `commands/invite.ts`** — Replace all string-interpolated SQL with parameterized queries. Split config loading: `loadCoreConfig()` for list/revoke, `loadAuth0Config()` additionally for create. Remove `getD1Options()` helper. Remove `sqlEscape()`.

5. **Update `commands/waitlist.ts`** — Replace `getD1Options()` with `loadCoreConfig()`. Update `query()` call signature (add empty params array).

6. **Update `commands/config.ts`** — Replace string-interpolated SQL with parameterized queries. Remove `sqlEscape()`. Keep `VALID_CONFIG_KEYS` whitelist for input validation (it validates the key is a known config key, which is a logic concern separate from SQL injection). Update `query()` call signature.

### Phase 3: Entry Point and Config

7. **Update `index.ts`** — Change `--env` option description from "Target environment" to "Path to .env file". Pass the value through to config loading.

8. **Update `.env.example`** — Replace `D1_DATABASE_ID` (existing), add `CLOUDFLARE_API_TOKEN` and `CLOUDFLARE_ACCOUNT_ID`, remove `AUTH0_AUDIENCE`. Add comments grouping core vs auth0 variables.

### Phase 4: Verification

9. **Typecheck** — `yarn workspace @reflog/cli typecheck` must pass.
10. **Manual smoke test** — Run each command against production and preview D1 databases to verify identical output.

## Complexity Tracking

No constitution violations. No additional complexity beyond what the spec requires.
