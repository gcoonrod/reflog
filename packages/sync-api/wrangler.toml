name = "reflog-sync-api"
main = "src/index.ts"
compatibility_date = "2024-12-01"
compatibility_flags = ["nodejs_compat"]

[vars]
AUTH0_DOMAIN = "reflog-microcode.us.auth0.com"
AUTH0_AUDIENCE = "https://sync.reflog.microcode.io"

[[d1_databases]]
binding = "DB"
database_name = "reflog-sync"
database_id = "0f8e68b4-13e4-4899-96b8-cb9cb4cefa91"

[observability]
[observability.logs]
enabled = true
invocation_logs = true
[observability.traces]
enabled = false

# Rate limiting (T044) — built-in Cloudflare Rate Limiting binding
[[ratelimits]]
name = "RATE_LIMITER_IP"
namespace_id = "1001"

  [ratelimits.simple]
  limit = 100
  period = 60

[[ratelimits]]
name = "RATE_LIMITER_USER"
namespace_id = "1002"

  [ratelimits.simple]
  limit = 200
  period = 60

# Tombstone GC cron (T047) — daily at 3 AM UTC
[triggers]
crons = ["0 3 * * *"]

# --- Preview Environment ---
[env.preview]
name = "reflog-sync-api-preview"

[env.preview.vars]
AUTH0_DOMAIN = "reflog-dev.us.auth0.com"
AUTH0_AUDIENCE = "https://sync-preview.reflog.microcode.io"

[[env.preview.d1_databases]]
binding = "DB"
database_name = "reflog-sync-preview"
database_id = "P5911abf9-62ba-423c-82f5-9782af5cb31f"

[[env.preview.ratelimits]]
name = "RATE_LIMITER_IP"
namespace_id = "2001"

  [env.preview.ratelimits.simple]
  limit = 100
  period = 60

[[env.preview.ratelimits]]
name = "RATE_LIMITER_USER"
namespace_id = "2002"

  [env.preview.ratelimits.simple]
  limit = 200
  period = 60

[env.preview.triggers]
crons = ["0 3 * * *"]
